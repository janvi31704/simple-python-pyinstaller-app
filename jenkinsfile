pipeline {
    agent any

    stages {

        stage('Setup Python Environment') {
            steps {
                // Upgrade pip and install dependencies inside Jenkins machine
                bat """
                    python3 -m pip install --upgrade pip
                    python3 -m pip install pytest pyinstaller
                """
            }
        }

        stage('Build') {
            steps {
                bat "python3 -m py_compile sources/add2vals.py sources/calc.py"
            }
        }

        stage('Test') {
            steps {
                bat """
                    mkdir test-reports
                    python3 -m pytest --verbose --junit-xml=test-reports/results.xml sources/test_calc.py
                """
            }
            post {
                always {
                    junit "test-reports/results.xml"
                }
            }
        }

        stage('Deliver') {
            steps {
                bat "pyinstaller --onefile sources/add2vals.py"
            }
            post {
                success {
                    archiveArtifacts "dist/add2vals.exe"
                }
            }
        }
    }
}
